name: Daily Podcast Generation

on:
  # ë§¤ì¼ ì˜¤ì „ 7ì‹œ (í•œêµ­ì‹œê°„)ì— ì‹¤í–‰
  # UTC ì‹œê°„ìœ¼ë¡œ ì„¤ì • (í•œêµ­ì‹œê°„ -9ì‹œê°„)
  # # í•œêµ­ì‹œê°„ ì˜¤ì „ 7ì‹œ = UTC 22ì‹œ (ì „ë‚ )
  schedule:
    - cron: "0 22 * * *" # ë§¤ì¼ UTC 22ì‹œ (í•œêµ­ì‹œê°„ ì˜¤ì „ 7ì‹œ)

  # feat/podcast-workflow ë¸Œëžœì¹˜ê°€ pushë  ë•Œ ì‹¤í–‰
  push:
    branches:
      - test

  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      urls:
        description: "URLs to process (comma-separated or file path)"
        required: false
        type: string

permissions:
  contents: write

jobs:
  generate-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install boto3  # Cloudflare R2 ì—…ë¡œë“œìš© (S3 í˜¸í™˜)
          # Gemini TTSëŠ” ê¸°ë³¸ì ìœ¼ë¡œ í¬í•¨ë˜ì–´ ìžˆìŒ

      - name: Install Playwright browsers
        run: |
          python -m playwright install chromium
          python -m playwright install-deps chromium

      - name: Update daily URLs from Naver News
        id: update_urls
        env:
          MAX_URLS: "5" # Maximum number of headlines to extract
        run: |
          python3 update_daily_urls.py

      - name: Generate Podcast and Upload to R2
        id: generate
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_DEV_SUBDOMAIN: ${{ secrets.R2_DEV_SUBDOMAIN }}
          URLS: ${{ github.event.inputs.urls }}
          TIMESTAMP: ${{ github.run_number }}-${{ github.run_id }}
          GITHUB_OUTPUT: ${{ github.output }}
        run: |
          python3 generate_podcast_workflow.py

      - name: Upload artifacts (backup)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: podcast-files-${{ github.run_number }}-${{ github.run_id }}
          path: |
            data/audio/*.mp3
            data/transcripts/*.txt
          retention-days: 7

      - name: Post to Twitter
        if: success()
        id: twitter
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
          PODCAST_URL: ${{ steps.generate.outputs.r2_url }}
        run: |
          pip install tweepy
          python3 post_to_twitter.py

      - name: Create summary
        if: success()
        run: |
          echo "## Podcast Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Podcast generated successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated Files:**" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.generate.outputs.audio_file }}" ]; then
            echo "- Audio: \`${{ steps.generate.outputs.audio_file }}\`" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -n "${{ steps.generate.outputs.r2_url }}" ]; then
            echo "- R2 URL: ${{ steps.generate.outputs.r2_url }}" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -n "${{ steps.twitter.outputs.tweet_url }}" ]; then
            echo "- ðŸ¦ Twitter: ${{ steps.twitter.outputs.tweet_url }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_number }}-${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
